<!DOCTYPE html>
<html>

  <head>
    <title>Tabula Demo</title>
   <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">

    <script src="<%= url_for("/jquery/jquery-1.12.4.min.js") %>"></script>
    <script src="<%= url_for("/bootstrap/js/bootstrap.js") %>"></script>

    <link rel="stylesheet" type="text/css"
      href="<%= url_for("/bootstrap/css/bootstrap.css") %>" media="all">

    <style type='text/css'>
      body {
        text-align: center;
        font-size: 16px;
        font-family: sans-serif;
      }
    </style>
  </head>

  <body>
    <div class="container" id="container">
      <br>

      <div id="noninteractive"></div>

      <br>

      <div class="row">
        <div class="col-xs-12 form-group">
          <form>
            <div class="input-group">

              <input type="text" id="input" class="form-control"
                placeholder="Press Enter to send data to interactive script">

              <span class="input-group-addon btn btn-primary"
                onclick="javascript:insert();">
                Send Data
              </span>

              <span class="input-group-addon btn btn-primary"
                onclick="javascript:selectFile();">
                Select File
              </span>
            </div>
          </form>
        </div>
      </div>

      <div id="data"></div>
      <div id="file"></div>

      <br>

      JPEG Resizer will resize your JPEG images to 20% of their original size<br>
      using the 'convert' binary from the ImageMagick Linux package.<br>
      All resized images will be written to a subdirectory of the selected image directory.<br>

      <br>

      <div class="row">
        <div class="btn btn-primary"
          onclick="javascript:selectImageDirectory();">
          Select Image Directory for JPEG Resizer
        </div>
      </div>

      <br>

      <div class="row">
        <div id="resizer-output"></div>
      </div>

      <br>

      <div class="row">
        <div id="resizer-message"></div>
      </div>

      <div class="row">
        <div class="btn btn-primary" id="resizer-stop-button"
          style="visibility:hidden;" onclick="javascript:killResizerScript();">
          Kill Script
        </div>
      </div>
      <br>
    </div>

    <script>
      var interactiveWebSocket;
      interactiveWebSocket = new WebSocket("<%= url_for('interactive')->to_abs %>");

      var nonInteractiveWebSocket;
      nonInteractiveWebSocket = new WebSocket("<%= url_for('noninteractive')->to_abs %>");

      var resizerWebSocket;
      resizerWebSocket = new WebSocket("<%= url_for('jpg_resizer')->to_abs %>");

      window.onbeforeunload = function() {
        var shutdownRequest = new XMLHttpRequest();
        shutdownRequest.open("GET", "/_quit_");
        shutdownRequest.send();
      }

      $(document).ready(function() {
        if (!("WebSocket" in window)) {
          alert('Your browser does not support WebSockets!');
          return;
        }

        $("#input").keypress(function(event) {
          if (event.which == 13) {
            event.preventDefault();
            insert();
          }
        });

        interactiveWebSocket.onmessage = function(event) {
          var data = event.data;

          if (data.indexOf("file://") >= 0) {
            $('#file').html("Last file: " + data.replace("file://", ""));
          }

          if (data.indexOf("file://") < 0) {
            $('#data').html(data);
          }
        };

        interactiveWebSocket.onclose = function(event) {
          webSocketClosed();
        }

        nonInteractiveWebSocket.onopen = function(event) {
          nonInteractiveWebSocket.send("Hello from a non-interactive script!");
        };

        nonInteractiveWebSocket.onmessage = function(event) {
          var data = event.data;
          $('#noninteractive').html(data);
        };

        resizerWebSocket.onmessage = function(event) {
          var data = event.data;

          $('#resizer-output').html(data);
          $('#resizer-stop-button').css({"visibility":"visible"});
          window.scrollTo(0, document.body.scrollHeight);

          if (data.indexOf("Resizing successfully completed") >= 0) {
            $('#resizer-stop-button').css({"visibility":"hidden"});
          }
        };
      });

      function insert() {
        var input = $('#input');
        interactiveWebSocket.send(input.val());
        input.val('');
      }

      function selectFile() {
        var command = '_select_file_';
        interactiveWebSocket.send(command);
      }

      function selectImageDirectory() {
        resizerWebSocket.send('_select_directory_');
      }

      function killResizerScript() {
        resizerWebSocket.send('_kill_');

        $('#resizer-message').html('Resizer killed!');
        $('#resizer-stop-button').css({"visibility":"hidden"});
      }

      function webSocketClosed() {
        $('#container').html('<br>Tabula local server is stopped. Close this window.');
        window.onbeforeunload = function () {}
      }
    </script>
  </body>
</html>
